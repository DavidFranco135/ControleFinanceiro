<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>FinanFlow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD9vzjo_nrSjaRZ5sXK7G4fhnTTxIW7c-k",
      authDomain: "planilha-fina.firebaseapp.com",
      projectId: "planilha-fina",
      storageBucket: "planilha-fina.firebasestorage.app",
      messagingSenderId: "288466007894",
      appId: "1:288466007894:web:e917cc6eeac421671188f7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const loginBox = document.getElementById("login");
    const appBox = document.getElementById("app");
    const form = document.getElementById("form");
    const list = document.getElementById("list");
    const balanceEl = document.getElementById("balance");

    let chart;
    let totalIn = 0;
    let totalOut = 0;

    document.getElementById("btnLogin").onclick = async () => {
      await signInWithEmailAndPassword(auth, email.value, password.value);
    };

    document.getElementById("btnRegister").onclick = async () => {
      await createUserWithEmailAndPassword(auth, email.value, password.value);
    };

    document.getElementById("logout").onclick = () => signOut(auth);

    onAuthStateChanged(auth, user => {
      if (user) {
        loginBox.classList.add("hidden");
        appBox.classList.remove("hidden");
        loadData(user.uid);
      } else {
        loginBox.classList.remove("hidden");
        appBox.classList.add("hidden");
      }
    });

    form.onsubmit = async e => {
      e.preventDefault();
      await addDoc(collection(db, "transactions"), {
        uid: auth.currentUser.uid,
        desc: desc.value,
        value: Number(value.value),
        type: type.value,
        date: date.value
      });
      form.reset();
    };

    function loadData(uid) {
      const q = query(collection(db, "transactions"), where("uid", "==", uid));
      onSnapshot(q, snap => {
        list.innerHTML = "";
        totalIn = totalOut = 0;
        snap.forEach(docu => {
          const d = docu.data();
          if (d.type === "in") totalIn += d.value;
          else totalOut += d.value;

          list.innerHTML += `
            <tr>
              <td>${d.desc}</td>
              <td>${d.type === "in" ? "Receita" : "Despesa"}</td>
              <td>R$ ${d.value.toFixed(2)}</td>
              <td>
                <button onclick="deleteItem('${docu.id}')" class="text-red-500">
                  <i class="fa fa-trash"></i>
                </button>
              </td>
            </tr>`;
        });
        balanceEl.innerText = `Saldo: R$ ${(totalIn - totalOut).toFixed(2)}`;
        drawChart();
      });
    }

    window.deleteItem = async id => {
      await deleteDoc(doc(db, "transactions", id));
    };

    function drawChart() {
      if (chart) chart.destroy();
      chart = new Chart(document.getElementById("chart"), {
        type: "bar",
        data: {
          labels: ["Receitas", "Despesas"],
          datasets: [{
            data: [totalIn, totalOut],
            backgroundColor: ["#10b981", "#ef4444"]
          }]
        }
      });
    }
  </script>
</head>

<body class="bg-slate-100">

<!-- LOGIN -->
<div id="login" class="min-h-screen flex items-center justify-center">
  <div class="bg-white p-8 rounded-xl shadow w-96">
    <h1 class="text-2xl font-bold mb-4 text-center">FinanFlow</h1>
    <input id="email" class="w-full p-2 border mb-2" placeholder="Email">
    <input id="password" type="password" class="w-full p-2 border mb-4" placeholder="Senha">
    <button id="btnLogin" class="w-full bg-indigo-600 text-white p-2 rounded mb-2">Entrar</button>
    <button id="btnRegister" class="w-full border p-2 rounded">Criar Conta</button>
  </div>
</div>

<!-- APP -->
<div id="app" class="hidden">
  <header class="bg-white p-4 shadow flex justify-between">
    <h2 class="font-bold">Controle Financeiro</h2>
    <button id="logout" class="text-red-500">Sair</button>
  </header>

  <main class="p-6 max-w-4xl mx-auto">
    <h3 id="balance" class="text-2xl font-bold mb-4">Saldo</h3>

    <canvas id="chart" class="mb-6"></canvas>

    <form id="form" class="grid grid-cols-4 gap-2 mb-6">
      <input id="desc" required class="p-2 border" placeholder="Descrição">
      <input id="value" required type="number" step="0.01" class="p-2 border" placeholder="Valor">
      <select id="type" class="p-2 border">
        <option value="in">Receita</option>
        <option value="out">Despesa</option>
      </select>
      <input id="date" type="date" class="p-2 border" required>
      <button class="col-span-4 bg-indigo-600 text-white p-2 rounded">Adicionar</button>
    </form>

    <table class="w-full bg-white rounded shadow">
      <thead>
        <tr class="bg-slate-200">
          <th>Descrição</th>
          <th>Tipo</th>
          <th>Valor</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="list"></tbody>
    </table>
  </main>
</div>

</body>
</html>
